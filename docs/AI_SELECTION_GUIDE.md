# 🤖 AI 기반 대원 선택 시스템 가이드

> 2025년 2월 1일 구현된 AI 기반 자동 대원 선택 시스템에 대한 상세 가이드입니다.

## 📋 목차
1. [시스템 개요](#시스템-개요)
2. [AI 점수 계산 방식](#ai-점수-계산-방식)
3. [자동 선택 기능](#자동-선택-기능)
4. [UI/UX 개선사항](#uiux-개선사항)
5. [구현 상세](#구현-상세)
6. [테스트 방법](#테스트-방법)

## 🎯 시스템 개요

### 주요 특징
- **AI 기반 점수 계산**: 도착시간, 거리, 자격증, 계급을 종합 평가
- **재난 종류별 자격증 가중치**: 화재/구조/구급 재난에 따른 적합 자격증 우선
- **자격증 상하위 관계 처리**: 상위 자격증 보유 시 하위 자격증 중복 제거
- **자동 선택**: 60초 카운트다운 후 최적 대원 자동 선택
- **실시간 경로 정보**: Tmap/Google Maps API로 정확한 도착 예상시간 계산
- **시각적 UI**: 최적 대원 배지, AI 점수 표시, 지도 연동

### 데이터 흐름
```
1. 대원 수락 → 위치/경로 정보 수집
2. AI 점수 계산 (재난 종류 고려) → 순위 결정
3. 자동/수동 선택 → 선택된 대원 배정
```

## 🧮 AI 점수 계산 방식

### 점수 구성 요소
```typescript
총점 = ETA점수 + 거리점수 + 자격증보너스 + 계급보너스
(낮을수록 좋음)
```

### 가중치 설정
- **ETA (도착시간)**: 1.0 (1초 = 1점)
- **거리**: 0.5 (1km = 0.5점)  
- **자격증**: -100 (보너스, 음수 = 유리)
- **계급**: -50 (보너스)

### 재난 종류별 자격증 점수 🎯

#### 화재 재난 🔥
- 화재대응능력 1급: 30점 (최우선)
- 화재대응능력 2급: 20점
- 인명구조사 1급: 15점
- 인명구조사 2급: 10점
- 응급구조사 1급: 10점
- 응급구조사 2급: 5점
- 간호사: 10점

#### 구조 재난 🚨
- 인명구조사 1급: 30점 (최우선)
- 인명구조사 2급: 20점
- 응급구조사 1급: 15점
- 응급구조사 2급: 10점
- 간호사: 15점
- 화재대응능력 1급: 10점
- 화재대응능력 2급: 5점

#### 구급 재난 🚑
- 응급구조사 1급: 30점 (최우선)
- 간호사: 30점 (동등하게 중요)
- 응급구조사 2급: 20점
- 인명구조사 1급: 10점
- 인명구조사 2급: 5점
- 화재대응능력 1급: 5점
- 화재대응능력 2급: 3점

#### 기타 재난 ⚠️
- 모든 자격증이 유사한 가중치 (10~15점)

### 자격증 상하위 관계 및 중복 처리 🎆 NEW!

#### 상하위 관계
- **화재대응능력**: 1급이 있으면 2급 무시
- **인명구조사**: 1급이 있으면 2급 무시
- **응급구조사**: 1급이 있으면 2급 무시

#### 동일 업무 영역 (중복 처리)
- **간호사와 응급구조사 1급**: 업무 영역이 유사하므로 둘 중 높은 점수 하나만 적용
- 예: 간호사 + 응급구조사 1급 보유 시 → 재난 종류에 따라 더 높은 점수만 반영

#### 점수 계산 예시
```
[화재 재난]
대원 A: 화재대응능력 1급 + 화재대응능력 2급
→ 화재대응능력 1급(30점)만 반영 ✅

대원 B: 간호사 + 응급구조사 1급 + 응급구조사 2급
→ 간호사(10점) 또는 응급구조사 1급(10점) 중 하나만 반영 ✅
→ 응급구조사 2급은 1급이 있으므로 무시 ❌

[구급 재난]
대원 C: 간호사 + 응급구조사 1급
→ 둘 다 30점이므로 30점만 반영 (중복 제거) ✅
```

### 계급 점수
- 소방사: 0점
- 소방교: 1점
- 소방장: 2점
- 소방위: 3점
- 소방경: 4점
- 소방령: 5점

## ⏱️ 자동 선택 기능

### 작동 방식
1. 관리자가 "자동 선택" 체크박스 활성화
2. 60초 카운트다운 시작
3. 실시간으로 최적 후보자 계산 (재난 종류 고려)
4. 카운트다운 종료 시 자동 선택 실행

### 중단 조건
- 수동으로 대원 선택 시
- 자동 선택 체크박스 해제 시
- 모든 후보자가 취소한 경우

## 🎨 UI/UX 개선사항

### 재난 종류별 자격증 중요도 표시
```
🔥 화재 재난 자격증 중요도: 화재대응능력 > 인명구조 > 응급구조
```

### 후보자 카드 디자인
```
┌─────────────────────────────────┐
│ 홍길동 [최적] [자동선택예정]    │ ← 배지 표시
│ 대원 · 소방장                   │
│ 🕐 5분  📍 2.3km               │ ← 경로 정보
│ 자격증: 화재대응능력1급, 응급2급 │
│ AI 점수: 265점 (화재 전문 자격증) │ ← 재난별 추천 이유
│                        [선택]    │
└─────────────────────────────────┘
```

### 시각적 구분
- **최적 후보자**: 파란색 배경 + "최적" 배지
- **자동 선택 예정**: 초록색 "자동 선택 예정" 배지 + 애니메이션
- **일반 후보자**: 흰색 배경

### 지도 연동
- 후보자 카드 클릭 → 해당 위치로 지도 이동
- panTo 애니메이션으로 부드럽게 이동
- 줌 레벨 15로 자동 조정

## 🔧 구현 상세

### 새로 추가된 파일
1. **aiScoringService.ts**: AI 점수 계산 로직 (재난 종류별 가중치 및 중복 처리)
2. **autoSelectService.ts**: 자동 선택 타이머 관리
3. **EnhancedCandidatesPanel.tsx**: 향상된 후보자 목록 UI

### 핵심 로직: 자격증 중복 처리
```typescript
// 상위 자격증이 있으면 하위 자격증 제거
if (certifications.includes('화재대응능력 1급')) {
  // 화재대응능력 2급 제거
}

// 동일 업무 영역 자격증 중 높은 점수만 적용
if (certifications.includes('간호사') && certifications.includes('응급구조사 1급')) {
  // 더 높은 점수 하나만 적용
}
```

## 🧪 테스트 방법

### 1. 자격증 중복 처리 테스트
```json
// 테스트 후보자 데이터
{
  "userId": "TestUser",
  "certifications": [
    "화재대응능력 1급",
    "화재대응능력 2급",  // 무시됨
    "간호사",
    "응급구조사 1급"     // 간호사와 중 하나만
  ]
}
```

### 2. 점수 계산 검증

#### 복잡한 자격증 조합 예시
```
[구급 재난]
대원 D: 간호사 + 응급구조사 1급 + 응급구조사 2급 + 인명구조사 1급
- 도착시간: 5분 (300초) → 300점
- 거리: 2km → 1점
- 자격증 처리:
  • 응급구조사 1급 있으므로 2급 무시 ❌
  • 간호사(30) vs 응급구조사 1급(30) → 30점만 적용
  • 인명구조사 1급(10) → 10점 적용
  • 총 자격증 점수: 40점
- 계급: 소방장(2) → -1점
- 총점: 300 + 1 - 40 - 1 = 260점 ✨
```

## 💡 활용 팁

### 관리자를 위한 팁
1. **자격증 확인**: 상위 자격증 보유자가 중복 점수를 받지 않음
2. **재난별 최적화**: 화재엔 화재대응능력, 구급엔 응급구조사/간호사
3. **AI 점수 신뢰**: 중복 제거로 더 정확한 평가

### 개발자를 위한 팁
1. **자격증 추가 시**: `CERTIFICATION_HIERARCHY`에 상하위 관계 정의
2. **동일 업무 영역**: `EQUIVALENT_CERTIFICATIONS`에 추가
3. **디버깅**: `getAppliedCertifications()` 메소드로 실제 적용된 자격증 확인

## 🚀 향후 개선 방향
1. **복합 자격증**: 다중 전문성을 가진 대원 우대
2. **자격증 만료일**: 유효기간 고려
3. **실무 경험**: 자격증 + 실제 출동 경험 가중치
4. **팀 구성**: 다양한 자격증 보유 팀 자동 구성

## 🔍 알려진 문제 및 해결 현황 (2025.02.01 추가)

### 해결된 문제
1. **경로 정보 없는 후보자의 AI 점수**
   - 현상: 김서연 같은 경로 정보 없는 후보자의 AI 점수가 비정상적으로 높게 표시
   - 해결: 
     - routeInfo 없을 때 기본값: ETA 99999초 (기존 999999), 거리 99.999km
     - AI 점수 50000 이상 시 "경로정보 없음"으로 표시
     - 추천 이유에서 도착시간은 routeInfo가 있을 때만 표시

2. **최적 대원 표시 개수**
   - 현상: 상위 3명이 모두 최적 배지를 받아 혼란
   - 해결: 테스트를 위해 임시로 1명만 표시하도록 변경
   - 주의: 실제 사용 시 3명으로 다시 변경 가능

### 해결 코드
```typescript
// aiScoringService.ts
// 1. 최적 후보자 1명만 표시 (테스트용)
scores.forEach((score, index) => {
  score.isOptimal = index < 1; // 3에서 1로 변경
});

// 2. routeInfo 없을 때 기본값 조정
const hasRouteInfo = candidate.routeInfo && 
  candidate.routeInfo.duration !== undefined &&
  candidate.routeInfo.distance !== undefined;

const etaSeconds = hasRouteInfo ? candidate.routeInfo.duration : 99999;
const distanceKm = hasRouteInfo ? (candidate.routeInfo.distance / 1000) : 99.999;

// 3. 추천 이유 생성 시 routeInfo 체크
if (candidate.routeInfo?.duration) {
  const etaMinutes = Math.ceil(candidate.routeInfo.duration / 60);
  if (etaMinutes <= 5) {
    reasons.push(`도착시간 ${etaMinutes}분`);
  }
}
```

```typescript
// EnhancedCandidatesInfo.tsx
// AI 점수 표시 개선
const formatAIScore = (score?: number): string => {
  if (!score) return '-';
  if (score > 50000) return '경로정보 없음';
  return Math.round(score).toLocaleString();
};
```

---

**작성일**: 2025년 2월 1일  
**업데이트**: 자격증 상하위 관계 및 중복 처리 추가
**작성자**: GoodPeople Emergency System 개발팀
