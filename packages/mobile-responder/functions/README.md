# Firebase Functions 개선사항

## 📋 개요
굿피플 119 시스템의 Firebase Functions를 모듈화하고 개선했습니다.

## 🚀 주요 개선사항

### 1. 코드 구조 개선
- **모듈화**: 기능별로 파일 분리
  - `utils/`: 유틸리티 함수들
  - `handlers/`: 비즈니스 로직 핸들러
- **재사용성**: 공통 기능을 유틸리티로 추출

### 2. 에러 처리 강화
- **구조화된 에러 메시지**: 사용자 친화적인 한글 메시지
- **에러 타입별 처리**: FCM 토큰 오류, 인증 오류 등 세분화
- **자동 토큰 정리**: 유효하지 않은 FCM 토큰 자동 삭제

### 3. 성능 최적화
- **배치 처리**: FCM 메시지를 500개씩 배치로 전송
- **병렬 처리**: Promise.all을 활용한 동시 처리
- **메모리 효율**: 대용량 데이터 처리 시 청크 단위 처리

### 4. 로깅 개선
- **구조화된 로그**: JSON 형식의 로그로 필터링 용이
- **로그 레벨**: INFO, ERROR, WARNING, DEBUG
- **상세 정보**: 타임스탬프, 사용자 ID, 에러 스택 등

### 5. 유효성 검증
- **입력값 검증**: 모든 입력값에 대한 철저한 검증
- **좌표 검증**: GPS 좌표의 유효성 확인
- **토큰 검증**: FCM 토큰 형식 검증

## 📁 파일 구조

```
functions/
├── index.js                 # 메인 진입점
├── package.json            # 의존성 관리
└── src/
    ├── handlers/           # 비즈니스 로직
    │   ├── notifications.js  # 알림 전송 핸들러
    │   ├── location.js      # 위치 업데이트 핸들러
    │   └── fcmToken.js      # FCM 토큰 핸들러
    └── utils/              # 유틸리티 함수
        ├── logger.js       # 로깅 유틸리티
        ├── distance.js     # 거리 계산 유틸리티
        ├── fcm.js         # FCM 관련 유틸리티
        └── validation.js   # 유효성 검증 유틸리티
```

## 🔧 주요 함수

### 1. sendCallNotification
- 호출 상태 변경 시 알림 전송
- 5km 반경 내 사용자에게 알림
- 새 호출, 재호출 구분

### 2. updateUserLocation
- 사용자 위치 실시간 업데이트
- 위치 히스토리 저장 (24시간)
- GPS 좌표 유효성 검증

### 3. updateFcmToken
- FCM 토큰 업데이트
- 토큰 변경 이력 추적
- 중복 업데이트 방지

### 4. testFcmSend
- 알림 테스트 기능
- 토큰 유효성 확인
- 상세한 에러 메시지

## 🛡️ 보안 개선
- 인증 필수 체크
- 토큰 일부만 로그에 저장
- 민감 정보 보호

## 📈 모니터링
- 알림 전송 로그
- 위치 업데이트 추적
- 에러 발생률 모니터링

## 🔄 배포 방법

```bash
# 함수 배포
npm run deploy

# 로그 확인
npm run logs

# 로컬 테스트
npm run serve
```

## ⚡ 성능 지표
- 알림 전송: 500명 동시 처리 가능
- 응답 시간: 평균 200ms 이하
- 에러율: 0.1% 미만 목표
